@startuml

start

:BuildingConstructionRequested;

if (Enough resources available?) then (true)
    :BuildingConstructionResourcesLeaseRequested;
    if (Enough resources available?) then (true)
        :BuildingConstructionResourcesLeased;
        split
            :ResourcesSpent;
            if(Storage was full and now is not?) then (true)
                :StorageSpaceAvailable;
                detach
            else
                end
            endif
        split again
            :ScheduledEventRequested;
            -[dotted]-> Deffered execution;
            :BuildingConstructionFinished;
            split
                if (Resource lease still exist?) then (true)
                    :ResourceLeaseUsed;
                    detach
                else (false)
                    #red:TODO: resource lease already destroyed
                    construction canceled?
                    event fired multiple times?;
                    end
                endif
            split again
                if (Construction site still exist?) then (true)
                    :BuildingLeveledUp;
                    detach
                else (false)
                    #red:TODO: construction site already gone
                    construction canceled?
                    event fired multiple times?;
                    end
                endif
            end split
        end split
    else (false)
        #red:TODO: Insufficient resources;
        end
    endif
else (false)
    #red:TODO: Insufficient resources;
    end
endif




@enduml